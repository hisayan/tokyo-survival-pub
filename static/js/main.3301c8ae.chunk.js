(this["webpackJsonptokyo-survival"]=this["webpackJsonptokyo-survival"]||[]).push([[0],{67:function(e,t,a){},69:function(e,t,a){},99:function(e,t,a){"use strict";a.r(t);var o=a(10),n=a(1),r=a.n(n),i=a(21),l=a.n(i),s=(a(67),a(18)),c=a.n(s),d=a(20),m=a(26),u=a(117),h=a(121),p=a(13),f=(a(69),a(16)),v=a.n(f),g=(a(87),a(123)),b=a(120),y=a(24),w=(a(88),a(92),{apiKey:"AIzaSyBMgLpqdddgG5plQhhTFN3KmNwMtCquK6s",authDomain:"tokyo-survival.firebaseapp.com",databaseURL:"https://tokyo-survival-default-rtdb.firebaseio.com",projectId:"tokyo-survival",storageBucket:"tokyo-survival.appspot.com",messagingSenderId:"953032005701",appId:"1:953032005701:web:df56c5e173995c61a3ab2c"});console.log(w),0===y.a.apps.length&&y.a.initializeApp(w);var j=y.a,x=y.a.database(),k=(y.a.auth(),a(122)),O=a(119),C=a(52),M=a.n(C),A=a(4),L=a(5),T=a(2),R=a(32),I=function(){function e(t){var a=this;Object(A.a)(this,e),this.modelOrigin=[139.6947214379419,35.679861724509934],this.modelAltitude=0,this.modelRotate=[Math.PI/2,0,0],this.modelAsMercatorCoordinate=void 0,this.modelTransform={},this.clock=new T.j,this.mixer=void 0,this.camera=void 0,this.scene=void 0,this.renderer=void 0,this.map=void 0,this.charactorLayer={id:"3d-model",type:"custom",renderingMode:"3d",onAdd:function(e,t){a.camera=new T.g,a.scene=new T.bb;var o=new T.l(16777215);o.position.set(0,-70,100).normalize(),a.scene.add(o);var n=new T.l(16777215);n.position.set(0,70,100).normalize(),a.scene.add(n),(new R.a).load("./RunningBoy.glb",(function(e){var t,o=e.scene,n=e.animations;if(n&&n.length){a.mixer=new T.b(o);for(var r=0;r<n.length;r++){var i=n[r],l=a.mixer.clipAction(i);console.log("play"),l.play()}}null===(t=a.scene)||void 0===t||t.add(e.scene)})),a.map=e,a.renderer=new T.nb({canvas:e.getCanvas(),context:t,antialias:!0}),a.renderer.autoClear=!1},render:function(e,t){var o,n,r=(new T.H).makeRotationAxis(new T.lb(1,0,0),a.modelTransform.rotateX),i=(new T.H).makeRotationAxis(new T.lb(0,1,0),a.modelTransform.rotateY),l=(new T.H).makeRotationAxis(new T.lb(0,0,1),a.modelTransform.rotateZ),s=(new T.H).fromArray(t),c=(new T.H).makeTranslation(a.modelTransform.translateX,a.modelTransform.translateY,a.map.painter.terrain.getAtPoint(a.modelAsMercatorCoordinate)*a.modelTransform.scale*100).scale(new T.lb(a.modelTransform.scale,-a.modelTransform.scale,a.modelTransform.scale)).multiply(r).multiply(i).multiply(l);a.mixer&&a.mixer.update(a.clock.getDelta()),a.camera&&(a.camera.projectionMatrix=s.multiply(c)),null===(o=a.renderer)||void 0===o||o.state.reset(),null===(n=a.renderer)||void 0===n||n.render(a.scene,a.camera),a.map.triggerRepaint()}},this.setLngLat(t)}return Object(L.a)(e,[{key:"setLngLat",value:function(e){this.modelAsMercatorCoordinate=v.a.MercatorCoordinate.fromLngLat(e,this.modelAltitude),this.modelTransform={translateX:this.modelAsMercatorCoordinate.x,translateY:this.modelAsMercatorCoordinate.y,translateZ:this.modelAsMercatorCoordinate.z,rotateX:this.modelRotate[0],rotateY:this.modelRotate[1],rotateZ:this.modelRotate[2],scale:this.modelAsMercatorCoordinate.meterInMercatorCoordinateUnits()/100}}}]),e}(),z=function(){function e(t,a){Object(A.a)(this,e),this.layerId=void 0,this.modelOrigin=[139.6947214379419,35.679861724509934],this.modelAltitude=0,this.modelRotate=[Math.PI/2,0,0],this.modelAsMercatorCoordinate=void 0,this.modelTransform={},this.clock=new T.j,this.mixer=void 0,this.camera=void 0,this.scene=void 0,this.renderer=void 0,this.map=void 0,this.layerId=a,this.setLngLat(t)}return Object(L.a)(e,[{key:"setLngLat",value:function(e){this.modelAsMercatorCoordinate=v.a.MercatorCoordinate.fromLngLat(e,this.modelAltitude),this.modelTransform={translateX:this.modelAsMercatorCoordinate.x,translateY:this.modelAsMercatorCoordinate.y,translateZ:this.modelAsMercatorCoordinate.z,rotateX:this.modelRotate[0],rotateY:this.modelRotate[1],rotateZ:this.modelRotate[2],scale:100*this.modelAsMercatorCoordinate.meterInMercatorCoordinateUnits()}}},{key:"charactorLayer",value:function(){var e=this;return{id:this.layerId,type:"custom",renderingMode:"3d",onAdd:function(t,a){e.camera=new T.g,e.scene=new T.bb;var o=new T.l(16777215);o.position.set(0,-70,100).normalize(),e.scene.add(o);var n=new T.l(16777215);n.position.set(0,70,100).normalize(),e.scene.add(n),(new R.a).load("./fire/scene.gltf",(function(t){var a,o=t.scene,n=t.animations;if(n&&n.length){e.mixer=new T.b(o);for(var r=0;r<n.length;r++){var i=n[r],l=e.mixer.clipAction(i);console.log("play"),l.play()}}null===(a=e.scene)||void 0===a||a.add(t.scene)})),e.map=t,e.renderer=new T.nb({canvas:t.getCanvas(),context:a,antialias:!0}),e.renderer.autoClear=!1},render:function(t,a){var o,n,r=(new T.H).makeRotationAxis(new T.lb(1,0,0),e.modelTransform.rotateX),i=(new T.H).makeRotationAxis(new T.lb(0,1,0),e.modelTransform.rotateY),l=(new T.H).makeRotationAxis(new T.lb(0,0,1),e.modelTransform.rotateZ),s=(new T.H).fromArray(a),c=(new T.H).makeTranslation(e.modelTransform.translateX,e.modelTransform.translateY,e.map.painter.terrain.getAtPoint(e.modelAsMercatorCoordinate)*e.modelTransform.scale/100).scale(new T.lb(e.modelTransform.scale,-e.modelTransform.scale,e.modelTransform.scale)).multiply(r).multiply(i).multiply(l);e.mixer&&e.mixer.update(e.clock.getDelta()),e.camera&&(e.camera.projectionMatrix=s.multiply(c)),null===(o=e.renderer)||void 0===o||o.state.reset(),null===(n=e.renderer)||void 0===n||n.render(e.scene,e.camera),e.map.triggerRepaint()}}}}]),e}();var S=function(e){var t=1e3;return e&&(t=e),M()((new Date).getTime().toString(16)+Math.floor(t*Math.random()).toString(16))}();console.log("uniqID",S);var P=!1;v.a.accessToken="pk.eyJ1IjoiaGlzYXlhbiIsImEiOiJja2ttY2NoY2QxcWt3Mm9wZ2VpaW5raXI0In0.UTR2shfZGifY-OlN_zpBFg";Object(u.a)((function(e){return Object(h.a)({paper:{display:"flex",border:"1px solid ".concat(e.palette.divider),flexWrap:"wrap"},divider:{margin:e.spacing(1,.5)}})}));var F=Object(p.a)((function(e){return{grouped:{backgroundColor:"#fff",margin:e.spacing(.5),border:"none","&:not(:first-child)":{borderRadius:e.shape.borderRadius},"&:first-child":{borderRadius:e.shape.borderRadius}}}}))(k.a),Y=new URLSearchParams(document.location.search.toString()).get("room");if(!Y||"/"==Y){var H;null!=(H=window.prompt("please input room's name"))?window.location.replace(window.location.pathname+"?room="+H):window.location.reload()}var Z,X=x.ref(Y+"/pov"),B=x.ref(Y+"/followMe");var E=[],N=function(){var e=Object(n.useState)(null),t=Object(d.a)(e,2),a=(t[0],t[1]);Object(n.useEffect)((function(){j.auth().signInAnonymously().catch((function(e){console.log("".concat(e.code,", ").concat(e.message))})),j.auth().onAuthStateChanged((function(e){console.log(e),a(e)}))}),[]);var r=Object(n.useState)(null),i=Object(d.a)(r,2),l=i[0],s=i[1],u=Object(n.useReducer)((function(e,t){return t&&B.update({owner:S,last_changed:j.database.ServerValue.TIMESTAMP}),t}),!1),h=Object(d.a)(u,2),p=h[0],f=h[1],y=Object(n.useReducer)((function(e,t){return p&&(console.log("followMe update",t),X.update(t)),t}),{lng:139.7,lat:35.68,zoom:17,pitch:85,bearing:80}),w=Object(d.a)(y,2),x=w[0],k=w[1],C=Object(n.useReducer)((function(e,t){return t}),{}),M=Object(d.a)(C,2),A=(M[0],M[1],Object(n.useRef)(null)),L=Object(n.useState)("fire"),T=Object(d.a)(L,2),R=T[0],Y=T[1];Object(n.useEffect)((function(){console.log("useEffect");return l||function(e){var t=e.setMap,a=e.mapContainer,o=new v.a.Map({container:null!==a.current?a.current:"",style:"mapbox://styles/mapbox/streets-v11",center:[x.lng,x.lat],zoom:x.zoom,pitch:x.pitch,bearing:x.bearing,antialias:!0});o.on("load",(function(){null===o||void 0===o||o.on("move",(function(){k({lng:o.getCenter().lng,lat:o.getCenter().lat,zoom:o.getZoom(),pitch:o.getPitch(),bearing:o.getBearing()})})),Z=new I({lng:139.7,lat:35.68}),null===o||void 0===o||o.addLayer(Z.charactorLayer),null===o||void 0===o||o.addSource("mapbox-dem",{type:"raster-dem",url:"mapbox://mapbox.mapbox-terrain-dem-v1",tileSize:512,maxzoom:14}),null===o||void 0===o||o.setTerrain({source:"mapbox-dem",exaggeration:1}),null===o||void 0===o||o.addSource("theRoute",{type:"geojson"}),null===o||void 0===o||o.addLayer({id:"theRoute",type:"line",source:"theRoute",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#cccccc","line-opacity":.5,"line-width":13,"line-blur":.5}}),null===o||void 0===o||o.addLayer({id:"sky",type:"sky",paint:{"sky-type":"atmosphere","sky-atmosphere-sun":[0,0],"sky-atmosphere-sun-intensity":15}})})),t(o)}({setMap:s,mapContainer:A}),function(){null===l||void 0===l||l.remove()}}),[l]),Object(n.useEffect)((function(){var e=function(){var e=Object(m.a)(c.a.mark((function e(t){var a,o,n;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.t0=R,e.next="line"===e.t0?3:"char"===e.t0?7:"fire"===e.t0?9:13;break;case 3:return document.createElement("div").className="marker",l&&(a=new v.a.Marker({draggable:!0}).setLngLat(t.lngLat).addTo(l),o=function(){var e=a.getLngLat();console.log(e)},a.on("dragend",o),a.setPopup(new v.a.Popup({offset:25}).setHTML("< h4>remove</h4"))),e.abrupt("break",13);case 7:return Z.setLngLat(t.lngLat),e.abrupt("break",13);case 9:return n=new z(t.lngLat,"fire_layer_"+E.length),null===l||void 0===l||l.addLayer(n.charactorLayer()),E.push(n),e.abrupt("break",13);case 13:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}();return null===l||void 0===l||l.on("click",e),function(){null===l||void 0===l||l.off("click",e)}}),[l,p,R]),Object(n.useEffect)((function(){return X.on("value",(function(e){console.log("povRef.on",e);var t=e.val();!p&&t&&P&&(null===l||void 0===l||l.jumpTo({center:[t.lng,t.lat],zoom:t.zoom,pitch:t.pitch,bearing:t.bearing})),P=!0})),B.on("value",(function(e){e.val().owner!=S&&p&&f(!1)})),function(){X.off("value"),B.off("value")}}),[p,S,l]);return Object(o.jsxs)("div",{children:[Object(o.jsxs)("div",{className:"header",children:[Object(o.jsx)("button",{id:"fit",onClick:function(){console.log("syncView",p.toString())},children:"sync view"}),Object(o.jsx)(g.a,{control:Object(o.jsx)(b.a,{checked:p,onChange:function(e,t){console.log("toggleChecked"),f(t),t&&k({lng:null===l||void 0===l?void 0:l.getCenter().lng,lat:null===l||void 0===l?void 0:l.getCenter().lat,zoom:null===l||void 0===l?void 0:l.getZoom(),pitch:null===l||void 0===l?void 0:l.getPitch(),bearing:null===l||void 0===l?void 0:l.getBearing()})}}),label:"Follow me",labelPlacement:"start"}),Object(o.jsxs)(F,{value:R,onChange:function(e,t){Y(t)},exclusive:!0,"aria-label":"text formatting",children:[Object(o.jsx)(O.a,{value:"line","aria-label":"line",children:"line"}),Object(o.jsx)(O.a,{value:"fire","aria-label":"fire",children:"fire"}),Object(o.jsx)(O.a,{value:"char","aria-label":"char",children:"char"})]})]}),Object(o.jsx)("div",{className:"sidebarStyle",children:Object(o.jsxs)("div",{children:["Longitude: ",x.lng.toFixed(4)," | Latitude: ",x.lat.toFixed(4)," | Zoom: ",x.zoom.toFixed(2)," | Pitch: ",x.pitch.toFixed(2)," | Bearing: ",x.bearing.toFixed(2)]})}),Object(o.jsx)("div",{ref:A,id:"mapContainer",className:"mapContainer"})]})},D=function(e){e&&e instanceof Function&&a.e(3).then(a.bind(null,125)).then((function(t){var a=t.getCLS,o=t.getFID,n=t.getFCP,r=t.getLCP,i=t.getTTFB;a(e),o(e),n(e),r(e),i(e)}))};l.a.render(Object(o.jsx)(r.a.StrictMode,{children:Object(o.jsx)(N,{})}),document.getElementById("root")),D()}},[[99,1,2]]]);
//# sourceMappingURL=main.3301c8ae.chunk.js.map