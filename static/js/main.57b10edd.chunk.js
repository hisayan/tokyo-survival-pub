(this["webpackJsonptokyo-survival"]=this["webpackJsonptokyo-survival"]||[]).push([[0],{67:function(e,t,a){},69:function(e,t,a){},99:function(e,t,a){"use strict";a.r(t);var n=a(10),o=a(1),r=a.n(o),i=a(21),l=a.n(i),s=(a(67),a(18)),c=a.n(s),d=a(20),m=a(26),u=a(117),h=a(121),p=a(13),f=(a(69),a(16)),g=a.n(f),v=(a(87),a(123)),b=a(120),y=a(24),j=(a(88),a(92),{apiKey:"AIzaSyBMgLpqdddgG5plQhhTFN3KmNwMtCquK6s",authDomain:"tokyo-survival.firebaseapp.com",databaseURL:"https://tokyo-survival-default-rtdb.firebaseio.com",projectId:"tokyo-survival",storageBucket:"tokyo-survival.appspot.com",messagingSenderId:"953032005701",appId:"1:953032005701:web:df56c5e173995c61a3ab2c"});console.log(j),0===y.a.apps.length&&y.a.initializeApp(j);var w=y.a,x=y.a.database(),k=(y.a.auth(),a(122)),O=a(119),C=a(52),L=a.n(C),M=a(4),A=a(5),T=a(2),R=a(32),z=function(){function e(t){var a=this;Object(M.a)(this,e),this.modelOrigin=[139.6947214379419,35.679861724509934],this.modelAltitude=0,this.modelRotate=[Math.PI/2,0,0],this.modelAsMercatorCoordinate=void 0,this.modelTransform={},this.clock=new T.j,this.mixer=void 0,this.camera=void 0,this.scene=void 0,this.renderer=void 0,this.map=void 0,this.charactorLayer={id:"3d-model",type:"custom",renderingMode:"3d",onAdd:function(e,t){a.camera=new T.g,a.scene=new T.bb;var n=new T.l(16777215);n.position.set(0,-70,100).normalize(),a.scene.add(n);var o=new T.l(16777215);o.position.set(0,70,100).normalize(),a.scene.add(o),(new R.a).load("./RunningBoy.glb",(function(e){var t,n=e.scene,o=e.animations;if(o&&o.length){a.mixer=new T.b(n);for(var r=0;r<o.length;r++){var i=o[r],l=a.mixer.clipAction(i);console.log("play"),l.play()}}null===(t=a.scene)||void 0===t||t.add(e.scene)})),a.map=e,a.renderer=new T.nb({canvas:e.getCanvas(),context:t,antialias:!0}),a.renderer.autoClear=!1},render:function(e,t){var n,o,r=(new T.H).makeRotationAxis(new T.lb(1,0,0),a.modelTransform.rotateX),i=(new T.H).makeRotationAxis(new T.lb(0,1,0),a.modelTransform.rotateY),l=(new T.H).makeRotationAxis(new T.lb(0,0,1),a.modelTransform.rotateZ),s=(new T.H).fromArray(t),c=(new T.H).makeTranslation(a.modelTransform.translateX,a.modelTransform.translateY,a.map.painter.terrain.getAtPoint(a.modelAsMercatorCoordinate)*a.modelTransform.scale*100).scale(new T.lb(a.modelTransform.scale,-a.modelTransform.scale,a.modelTransform.scale)).multiply(r).multiply(i).multiply(l);a.mixer&&a.mixer.update(a.clock.getDelta()),a.camera&&(a.camera.projectionMatrix=s.multiply(c)),null===(n=a.renderer)||void 0===n||n.state.reset(),null===(o=a.renderer)||void 0===o||o.render(a.scene,a.camera),a.map.triggerRepaint()}},this.setLngLat(t)}return Object(A.a)(e,[{key:"setLngLat",value:function(e){this.modelAsMercatorCoordinate=g.a.MercatorCoordinate.fromLngLat(e,this.modelAltitude),this.modelTransform={translateX:this.modelAsMercatorCoordinate.x,translateY:this.modelAsMercatorCoordinate.y,translateZ:this.modelAsMercatorCoordinate.z,rotateX:this.modelRotate[0],rotateY:this.modelRotate[1],rotateZ:this.modelRotate[2],scale:this.modelAsMercatorCoordinate.meterInMercatorCoordinateUnits()/100}}}]),e}(),I=function(){function e(t,a){Object(M.a)(this,e),this.layerId=void 0,this.modelOrigin=[139.6947214379419,35.679861724509934],this.modelAltitude=0,this.modelRotate=[Math.PI/2,0,0],this.modelAsMercatorCoordinate=void 0,this.modelTransform={},this.clock=new T.j,this.mixer=void 0,this.camera=void 0,this.scene=void 0,this.renderer=void 0,this.map=void 0,this.layerId=a,this.setLngLat(t)}return Object(A.a)(e,[{key:"setLngLat",value:function(e){this.modelAsMercatorCoordinate=g.a.MercatorCoordinate.fromLngLat(e,this.modelAltitude),this.modelTransform={translateX:this.modelAsMercatorCoordinate.x,translateY:this.modelAsMercatorCoordinate.y,translateZ:this.modelAsMercatorCoordinate.z,rotateX:this.modelRotate[0],rotateY:this.modelRotate[1],rotateZ:this.modelRotate[2],scale:100*this.modelAsMercatorCoordinate.meterInMercatorCoordinateUnits()}}},{key:"charactorLayer",value:function(){var e=this;return{id:this.layerId,type:"custom",renderingMode:"3d",onAdd:function(t,a){e.camera=new T.g,e.scene=new T.bb;var n=new T.l(16777215);n.position.set(0,-70,100).normalize(),e.scene.add(n);var o=new T.l(16777215);o.position.set(0,70,100).normalize(),e.scene.add(o),(new R.a).load("./fire/scene.gltf",(function(t){var a,n=t.scene,o=t.animations;if(o&&o.length){e.mixer=new T.b(n);for(var r=0;r<o.length;r++){var i=o[r],l=e.mixer.clipAction(i);console.log("play"),l.play()}}null===(a=e.scene)||void 0===a||a.add(t.scene)})),e.map=t,e.renderer=new T.nb({canvas:t.getCanvas(),context:a,antialias:!0}),e.renderer.autoClear=!1},render:function(t,a){var n,o,r=(new T.H).makeRotationAxis(new T.lb(1,0,0),e.modelTransform.rotateX),i=(new T.H).makeRotationAxis(new T.lb(0,1,0),e.modelTransform.rotateY),l=(new T.H).makeRotationAxis(new T.lb(0,0,1),e.modelTransform.rotateZ),s=(new T.H).fromArray(a),c=(new T.H).makeTranslation(e.modelTransform.translateX,e.modelTransform.translateY,e.map.painter.terrain.getAtPoint(e.modelAsMercatorCoordinate)*e.modelTransform.scale/100).scale(new T.lb(e.modelTransform.scale,-e.modelTransform.scale,e.modelTransform.scale)).multiply(r).multiply(i).multiply(l);e.mixer&&e.mixer.update(e.clock.getDelta()),e.camera&&(e.camera.projectionMatrix=s.multiply(c)),null===(n=e.renderer)||void 0===n||n.state.reset(),null===(o=e.renderer)||void 0===o||o.render(e.scene,e.camera),e.map.triggerRepaint()}}}}]),e}();var S=function(e){var t=1e3;return e&&(t=e),L()((new Date).getTime().toString(16)+Math.floor(t*Math.random()).toString(16))}();console.log("uniqID",S);var P=!1;g.a.accessToken="pk.eyJ1IjoiaGlzYXlhbiIsImEiOiJjamZmbmRnazgxd3Y0MnptczRxeGZ3ZWNxIn0.5fLsZKfr7Y1LWgjDJVkoIg";Object(u.a)((function(e){return Object(h.a)({paper:{display:"flex",border:"1px solid ".concat(e.palette.divider),flexWrap:"wrap"},divider:{margin:e.spacing(1,.5)}})}));var Z=Object(p.a)((function(e){return{grouped:{backgroundColor:"#fff",margin:e.spacing(.5),border:"none","&:not(:first-child)":{borderRadius:e.shape.borderRadius},"&:first-child":{borderRadius:e.shape.borderRadius}}}}))(k.a),F=new URLSearchParams(document.location.search.toString()).get("room");if(!F||"/"==F){var H;null!=(H=window.prompt("please input room's name"))?window.location.replace(window.location.pathname+"?room="+H):window.location.reload()}var Y,E=x.ref(F+"/pov"),X=x.ref(F+"/followMe");var B=[],D=function(){var e=Object(o.useState)(null),t=Object(d.a)(e,2),a=(t[0],t[1]);Object(o.useEffect)((function(){w.auth().signInAnonymously().catch((function(e){console.log("".concat(e.code,", ").concat(e.message))})),w.auth().onAuthStateChanged((function(e){console.log(e),a(e)}))}),[]);var r=Object(o.useState)(null),i=Object(d.a)(r,2),l=i[0],s=i[1],u=Object(o.useReducer)((function(e,t){return t&&X.update({owner:S,last_changed:w.database.ServerValue.TIMESTAMP}),t}),!1),h=Object(d.a)(u,2),p=h[0],f=h[1],y=Object(o.useReducer)((function(e,t){return p&&(console.log("followMe update",t),E.update(t)),t}),{lng:139.7,lat:35.68,zoom:17,pitch:85,bearing:80}),j=Object(d.a)(y,2),x=j[0],k=j[1],C=Object(o.useReducer)((function(e,t){return t}),{}),L=Object(d.a)(C,2),M=(L[0],L[1],Object(o.useRef)(null)),A=Object(o.useState)("fire"),T=Object(d.a)(A,2),R=T[0],F=T[1];Object(o.useEffect)((function(){console.log("useEffect");return l||function(e){var t=e.setMap,a=e.mapContainer,n=new g.a.Map({container:null!==a.current?a.current:"",style:"mapbox://styles/mapbox/streets-v11",center:[x.lng,x.lat],zoom:x.zoom,pitch:x.pitch,bearing:x.bearing,antialias:!0});n.on("load",(function(){null===n||void 0===n||n.on("move",(function(){k({lng:n.getCenter().lng,lat:n.getCenter().lat,zoom:n.getZoom(),pitch:n.getPitch(),bearing:n.getBearing()})})),Y=new z({lng:139.7,lat:35.68}),null===n||void 0===n||n.addLayer(Y.charactorLayer),null===n||void 0===n||n.addSource("mapbox-dem",{type:"raster-dem",url:"mapbox://mapbox.mapbox-terrain-dem-v1",tileSize:512,maxzoom:14}),null===n||void 0===n||n.setTerrain({source:"mapbox-dem",exaggeration:1}),null===n||void 0===n||n.addSource("theRoute",{type:"geojson"}),null===n||void 0===n||n.addLayer({id:"theRoute",type:"line",source:"theRoute",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#cccccc","line-opacity":.5,"line-width":13,"line-blur":.5}}),null===n||void 0===n||n.addLayer({id:"sky",type:"sky",paint:{"sky-type":"atmosphere","sky-atmosphere-sun":[0,0],"sky-atmosphere-sun-intensity":15}})})),t(n)}({setMap:s,mapContainer:M}),function(){null===l||void 0===l||l.remove()}}),[l]),Object(o.useEffect)((function(){var e=function(){var e=Object(m.a)(c.a.mark((function e(t){var a,n,o;return c.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.t0=R,e.next="line"===e.t0?3:"char"===e.t0?7:"fire"===e.t0?9:13;break;case 3:return document.createElement("div").className="marker",l&&(a=new g.a.Marker({draggable:!0}).setLngLat(t.lngLat).addTo(l),n=function(){var e=a.getLngLat();console.log(e)},a.on("dragend",n),a.setPopup(new g.a.Popup({offset:25}).setHTML("< h4>remove</h4"))),e.abrupt("break",13);case 7:return Y.setLngLat(t.lngLat),e.abrupt("break",13);case 9:return o=new I(t.lngLat,"fire_layer_"+B.length),null===l||void 0===l||l.addLayer(o.charactorLayer()),B.push(o),e.abrupt("break",13);case 13:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}();return null===l||void 0===l||l.on("click",e),function(){null===l||void 0===l||l.off("click",e)}}),[l,p,R]),Object(o.useEffect)((function(){return E.on("value",(function(e){console.log("povRef.on",e);var t=e.val();!p&&t&&P&&(null===l||void 0===l||l.jumpTo({center:[t.lng,t.lat],zoom:t.zoom,pitch:t.pitch,bearing:t.bearing})),P=!0})),X.on("value",(function(e){e.val().owner!=S&&p&&f(!1)})),function(){E.off("value"),X.off("value")}}),[p,S,l]);return Object(n.jsxs)("div",{children:[Object(n.jsxs)("div",{className:"header",children:[Object(n.jsx)("button",{id:"fit",onClick:function(){console.log("syncView",p.toString())},children:"sync view"}),Object(n.jsx)(v.a,{control:Object(n.jsx)(b.a,{checked:p,onChange:function(e,t){console.log("toggleChecked"),f(t),t&&k({lng:null===l||void 0===l?void 0:l.getCenter().lng,lat:null===l||void 0===l?void 0:l.getCenter().lat,zoom:null===l||void 0===l?void 0:l.getZoom(),pitch:null===l||void 0===l?void 0:l.getPitch(),bearing:null===l||void 0===l?void 0:l.getBearing()})}}),label:"Follow me",labelPlacement:"start"}),Object(n.jsxs)(Z,{value:R,onChange:function(e,t){F(t)},exclusive:!0,"aria-label":"text formatting",children:[Object(n.jsx)(O.a,{value:"line","aria-label":"line",children:"line"}),Object(n.jsx)(O.a,{value:"fire","aria-label":"fire",children:"fire"}),Object(n.jsx)(O.a,{value:"char","aria-label":"char",children:"char"})]})]}),Object(n.jsx)("div",{className:"sidebarStyle",children:Object(n.jsxs)("div",{children:["Longitude: ",x.lng.toFixed(4)," | Latitude: ",x.lat.toFixed(4)," | Zoom: ",x.zoom.toFixed(2)," | Pitch: ",x.pitch.toFixed(2)," | Bearing: ",x.bearing.toFixed(2)]})}),Object(n.jsx)("div",{ref:M,id:"mapContainer",className:"mapContainer"})]})},N=function(e){e&&e instanceof Function&&a.e(3).then(a.bind(null,125)).then((function(t){var a=t.getCLS,n=t.getFID,o=t.getFCP,r=t.getLCP,i=t.getTTFB;a(e),n(e),o(e),r(e),i(e)}))};l.a.render(Object(n.jsx)(r.a.StrictMode,{children:Object(n.jsx)(D,{})}),document.getElementById("root")),N()}},[[99,1,2]]]);
//# sourceMappingURL=main.57b10edd.chunk.js.map